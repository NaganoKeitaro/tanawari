# 詳細設計書 (Detailed Design Document)

**作成日**: 2026-01-09
**プロジェクト**: 棚割管理システム (Planogram System) MVP

## 1. プログラム設計書 (Logic Design)

本システムの中核となる「個店棚割自動生成ロジック」の詳細を定義する。

### 1.1 共通前提
*   **入力**: 標準棚割（商品リスト、配置）、店舗棚サイズ（幅）、商品売上ランク
*   **出力**: 個店棚割（商品リスト、配置、メタデータ）
*   **座標計算**: 左下を原点(0,0)とし、商品は `position_x`（左端からの距離）と `shelf_index`（段数）で管理する。

### 1.2 ロジックA: カット (Cut)
店舗棚幅 < 標準棚幅 の場合に適用される縮小ロジック。重要度の低い商品から削除する。

**処理フロー**:
1.  **判定**: `Store.width < StandardPlanogram.width`
2.  **フェイス削減ループ**:
    *   標準棚割内の全商品を対象とする。
    *   売上ランク順（昇順：ランク数値が大きい＝売上が低い順）にソート。
    *   各商品のフェイス数が2以上であれば、1になるまで減らす。
    *   削減の都度、総幅を再計算し、`Store.width` に収まれば終了。
3.  **商品削除ループ**:
    *   フェイス削減でも収まらない場合、売上ランクの低い順（数値が大きい順）に商品を削除（`is_cut=true`）する。
    *   削除の都度、総幅を再計算し、収まれば終了。
4.  **再配置**:
    *   残った商品を、左詰めなどのルールに従って各段に再配置する（X座標の再計算）。

### 1.3 ロジックB: 拡張 (Expand)
店舗棚幅 > 標準棚幅 の場合に適用される拡張ロジック。売れ筋商品を拡充する。

**処理フロー**:
1.  **判定**: `Store.width > StandardPlanogram.width`
2.  **トップ商品拡充**:
    *   売上ランク上位10商品（ランク数値が小さい順）を抽出。
    *   対象商品のフェイス数を+1する（例：1→2）。
    *   総幅を再計算し、`Store.width` を超えた場合は、超えた時点で追加を取り消して終了。
3.  **準トップ商品拡充**:
    *   まだ余裕がある場合、残りの上位商品（11位以降）についても順次フェイス数を+1する。
    *   同様に幅上限チェックを行う。
4.  **余白調整**:
    *   これ以上商品を増やせない、または全商品2フェイス以上になった等のリミットに達した場合、残りは「余白」として扱う（X座標の調整は行わず、右端が空く形式とする）。

### 1.4 ロジックC: 同期 (Sync)
標準棚割の変更を、編集済みの個店棚割に反映させるマージロジック。

**処理フロー**:
1.  **Inputs**: 最新の標準棚割、現在の個店棚割
2.  **Diff検出**: 標準棚割で追加・削除された商品を特定。
3.  **マージ**:
    *   **追加商品**: 個店棚割の適切な位置（標準での相対位置に近い場所）に挿入。
    *   **削除商品**: 個店棚割から削除。
    *   **維持商品**: 個店側で手動調整されたフェイス数や位置は可能な限り維持するが、標準側で大幅なカットがあった場合は標準を優先するオプションも設ける（MVPでは標準優先リセットを推奨）。

## 2. バッチ設計書 (Batch Design)

MVPではサーバーサイドバッチではなく、クライアントサイドでの「一括処理」として実装する。

### 2.1 個店棚割一括生成処理
全店舗に対して、適切な標準棚割を適用し、カット/拡張ロジックを実行する。

*   **トリガー**: ユーザーがUI上の「全店展開実行」ボタンを押下。
*   **処理フロー**:
    1.  店舗リストを取得。
    2.  各店舗について：
        *   店舗の `region` と `fmt` に合致する標準棚割を検索。
        *   ロジックAまたはBを適用して `StorePlanogram` データを生成。
        *   生成結果をローカルDB（IndexedDB/LocalStorage）に保存。
        *   進捗状況（Progress）をUIに通知。
    3.  完了後、成功件数・エラー件数・警告（大幅なカットが発生した店舗など）をレポート表示。

## 3. 外部インタフェース設計書 (External Interface Design)

### 3.1 データ入出力 (Data I/O)
外部システム（基幹システム等）との連携を想定したCSV/JSON入出力仕様。

#### 3.1.1 商品マスタインポート
*   **形式**: CSV
*   **文字コード**: UTF-8
*   **項目**: JANコード, 商品名, カテゴリ, 幅, 高さ, 奥行, 売上ランク
*   **エラー処理**: JAN重複はスキップまたは上書き（選択可）。必須項目欠損はエラーログ出力。

#### 3.1.2 店舗マスタインポート
*   **形式**: CSV
*   **項目**: 店舗コード, 店舗名, FMT, 地域, 什器幅合計
*   **処理**: 既存店舗コードは更新、新規は追加。

### 3.2 アプリケーションインタフェース (Repository API)
データアクセス層のインターフェース定義（TypeScript）。

```typescript
interface IProductRepository {
  getAll(): Promise<Product[]>;
  getById(id: string): Promise<Product | null>;
  save(product: Product): Promise<void>;
  bulkImport(products: Product[]): Promise<ImportResult>;
}

interface IStorePlanogramRepository {
  findByStoreId(storeId: string): Promise<StorePlanogram | null>;
  save(planogram: StorePlanogram): Promise<void>;
  saveBulk(planograms: StorePlanogram[]): Promise<void>;
}
```

## 4. 性能・運用設計書 (Performance & Operation Design)

### 4.1 性能要件
*   **レスポンス**:
    *   棚割エディタでのドラッグ＆ドロップ操作：**100ms以内** に追従すること（カクつきを感じさせない）。
    *   画面遷移：**1秒以内**。
*   **処理時間**:
    *   一括生成（100店舗想定）：**10秒以内**（クライアントサイド処理）。
*   **データ量**:
    *   商品マスタ：最大5,000件程度。
    *   1棚割あたりの商品配置数：最大300件程度。
    *   ブラウザのメモリ制限を考慮し、不要なオブジェクトは適宜解放する。

### 4.2 運用・監視設計
*   **ログ**:
    *   アプリケーションエラー（予期せぬ例外）は `console.error` に出力し、開発者ツールで確認可能にする。
    *   MVP段階ではサーバーサイドログ収集は行わない。
*   **バックアップ**:
    *   「データエクスポート」機能により、全データをJSONファイルとしてローカルPCに保存可能にする。
    *   運用担当者が定期的にエクスポートを行う運用フローとする。

## 5. 移行設計書 (Migration Design)

### 5.1 データ移行（初期ロード）
システム利用開始時のデータセットアップ手順。

1.  **商品・店舗マスタ**:
    *   所定のCSVフォーマットでデータを作成。
    *   「設定」＞「データインポート」から取り込む。
    *   または、開発用シードデータスクリプト (`src/data/seed/`) を実行して初期状態を構築する。
2.  **標準棚割**:
    *   マスタ移行後、本部担当者が画面上で手動作成する（移行ツールは作成しない）。

## 6. テスト方針書 (Test Policy)

### 6.1 テストレベルと範囲

| テストレベル | 対象 | 実施方法 | 評価基準 |
| :--- | :--- | :--- | :--- |
| **単体テスト (Unit)** | 自動化ロジック (Cut/Expand/Sync) | Vitestによる自動テスト | ・境界値（幅がぴったり、1mm足りない等）で意図通り動作すること。<br>・ランク順序通りに処理されること。 |
| **結合テスト (Integration)** | 画面遷移、データ保存 | 手動操作 | ・保存したデータが再読み込みで正しく復元されること。<br>・画面間のデータ受け渡しが正常であること。 |
| **システムテスト (E2E)** | 一連の業務フロー | ブラウザ手動操作 | ・マスタ登録～標準作成～個店展開～微調整の流れが滞りなく行えること。 |

### 6.2 重点テスト観点
1.  **ロジックの正確性**:
    *   カット時に、高ランク商品が削除されていないか。
    *   拡張時に、棚幅があふれていないか。
2.  **パフォーマンス**:
    *   商品数が多い棚割（300品以上）での操作レスポンス。
3.  **例外系**:
    *   極端に狭い店舗（商品が1つも入らない）での挙動。
    *   マスタ削除後の棚割データの整合性。
